## **1.시퀀스 생성 쿼리**
-----
```sql
-- 1. 직원 테이블 시퀀스
CREATE SEQUENCE employee_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 2. 직급 테이블 시퀀스
CREATE SEQUENCE role_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 3. 재료 테이블 시퀀스
CREATE SEQUENCE ingredient_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 4. 재료 카테고리 테이블 시퀀스
CREATE SEQUENCE ingredient_category_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 5. 상품 테이블 시퀀스
CREATE SEQUENCE product_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 6. 상품 카테고리 테이블 시퀀스
CREATE SEQUENCE product_category_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 7. 주문 테이블 시퀀스
CREATE SEQUENCE order_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 8. 판매 테이블 시퀀스
CREATE SEQUENCE sale_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 9. 급여 테이블 시퀀스
CREATE SEQUENCE salary_seq
START WITH 1
INCREMENT BY 1
NOCACHE;

-- 10. 재고 기록 테이블 시퀀스
CREATE SEQUENCE stock_log_seq
START WITH 1
INCREMENT BY 1
NOCACHE;
```

<br/><br/>


## **2. 테이블 생성 쿼리**
-----
```sql
-- 1. 직급 테이블 (직원 테이블에서 참조됨)
CREATE TABLE Roles (
    role_id NUMBER PRIMARY KEY,
    role_name VARCHAR2(50) NOT NULL
);

-- 2. 직원 테이블
CREATE TABLE Employees (
    employee_id NUMBER PRIMARY KEY,
    password_hash VARCHAR2(255) NOT NULL,
    name VARCHAR2(100) NOT NULL,
    contact VARCHAR2(15),
    hire_date DATE DEFAULT SYSDATE,
    role_id NUMBER NOT NULL,
    CONSTRAINT fk_employee_role FOREIGN KEY (role_id)
        REFERENCES Roles(role_id)
);

-- 3. 재료 카테고리 테이블 (재료 테이블에서 참조됨)
CREATE TABLE Ingredient_Categories (
    category_id NUMBER PRIMARY KEY,
    category_name VARCHAR2(100) NOT NULL
);

-- 4. 재료 테이블
CREATE TABLE Ingredients (
    ingredient_id NUMBER PRIMARY KEY,
    category_id NUMBER NOT NULL,
    name VARCHAR2(100) NOT NULL,
    unit_price NUMBER NOT NULL,
    unit VARCHAR2(20) NOT NULL,
    CONSTRAINT fk_ingredient_category FOREIGN KEY (category_id)
        REFERENCES Ingredient_Categories(category_id)
);

-- 5. 상품 카테고리 테이블 (상품 테이블에서 참조됨)
CREATE TABLE Product_Categories (
    category_id NUMBER PRIMARY KEY,
    category_name VARCHAR2(100) NOT NULL
);

-- 6. 상품 테이블
CREATE TABLE Products (
    product_id NUMBER PRIMARY KEY,
    category_id NUMBER NOT NULL,
    name VARCHAR2(100) NOT NULL,
    price NUMBER NOT NULL,
    CONSTRAINT fk_product_category FOREIGN KEY (category_id)
        REFERENCES Product_Categories(category_id)
);

-- 7. 상품-재료 매핑 테이블
CREATE TABLE Product_Ingredients (
    product_id NUMBER NOT NULL,
    ingredient_id NUMBER NOT NULL,
    required_amount NUMBER NOT NULL,
    CONSTRAINT pk_prod_ing PRIMARY KEY (product_id, ingredient_id),
    CONSTRAINT fk_prod_ing_product FOREIGN KEY (product_id)
        REFERENCES Products(product_id),
    CONSTRAINT fk_prod_ing_ingredient FOREIGN KEY (ingredient_id)
        REFERENCES Ingredients(ingredient_id)
);

-- 8. 재고 테이블
CREATE TABLE Stock (
    ingredient_id NUMBER PRIMARY KEY,
    current_stock NUMBER DEFAULT 0,
    CONSTRAINT fk_stock_ingredient FOREIGN KEY (ingredient_id)
        REFERENCES Ingredients(ingredient_id)
);

-- 9. 재고 기록 테이블
CREATE TABLE Stock_Logs (
    stock_log_id NUMBER PRIMARY KEY,
    ingredient_id NUMBER NOT NULL,
    change_amount NUMBER NOT NULL,
    log_date DATE DEFAULT SYSDATE,
    reason VARCHAR2(255),
    CONSTRAINT fk_stock_log_ingredient FOREIGN KEY (ingredient_id)
        REFERENCES Ingredients(ingredient_id)
);

-- 10. 주문 테이블
CREATE TABLE Orders (
    order_id NUMBER PRIMARY KEY,
    ingredient_id NUMBER NOT NULL,
    supplier VARCHAR2(100),
    order_date DATE DEFAULT SYSDATE,
    quantity NUMBER NOT NULL,
    total_price NUMBER NOT NULL,
    CONSTRAINT fk_order_ingredient FOREIGN KEY (ingredient_id)
        REFERENCES Ingredients(ingredient_id)
);

-- 11. 판매 테이블
CREATE TABLE Sales (
    sale_id NUMBER PRIMARY KEY,
    product_id NUMBER NOT NULL,
    sale_date DATE DEFAULT SYSDATE,
    quantity NUMBER NOT NULL,
    total_price NUMBER NOT NULL,
    CONSTRAINT fk_sale_product FOREIGN KEY (product_id)
        REFERENCES Products(product_id)
);

-- 12. 급여 테이블
CREATE TABLE Salaries (
    salary_id NUMBER PRIMARY KEY,
    employee_id NUMBER NOT NULL,
    payment_date DATE DEFAULT SYSDATE,
    payment_amount NUMBER NOT NULL,
    payment_type VARCHAR2(50),
    CONSTRAINT fk_salary_employee FOREIGN KEY (employee_id)
        REFERENCES Employees(employee_id)
);
```
**생성 쿼리 순서**
1. Foreign Key로 참조되는 상위 테이블 부터 생성:
   - `Roles`, `Ingredient_Categories`, `Product_Categories`.

2. 그 다음 참조하는 하위 테이블 생성:
   - `Employees`, `Ingredients`, `Products`.

3. 마지막으로 연결 테이블 및 기록 테이블 생성:
   - `Product_Ingredients`, `Orders`, `Sales`, `Salaries`, `Stock`, `Stock_Logs`.

**수정된 식별자**
식별자 이름을 간소화하여 30자 이내로 줄임.
| 원래 이름                           | 수정된 이름              |
| ----------------------------------- | ------------------------ |
| `pk_product_ingredients`            | `pk_prod_ing`            |
| `fk_product_ingredients_product`    | `fk_prod_ing_product`    |
| `fk_product_ingredients_ingredient` | `fk_prod_ing_ingredient` |


  
<br/><br/>


## **3. 트리거 생성 쿼리**
-----

```sql
-- 1. 판매 → 재고 감소 트리거
CREATE OR REPLACE TRIGGER update_stock_after_sale
AFTER INSERT ON Sales
FOR EACH ROW
BEGIN
    FOR r IN (
        SELECT ingredient_id, required_amount * :NEW.quantity AS total_amount
        FROM Product_Ingredients
        WHERE product_id = :NEW.product_id
    ) LOOP
        UPDATE Stock
        SET current_stock = current_stock - r.total_amount
        WHERE ingredient_id = r.ingredient_id;
        
        -- 재고 기록 생성
        INSERT INTO Stock_Logs (stock_log_id, ingredient_id, change_amount, log_date, reason)
        VALUES (stock_log_seq.NEXTVAL, r.ingredient_id, -r.total_amount, SYSDATE, '판매로 인한 감소');
    END LOOP;
END;
/

-- 2. 주문 → 재고 증가 트리거
CREATE OR REPLACE TRIGGER update_stock_after_order
AFTER INSERT ON Orders
FOR EACH ROW
BEGIN
    UPDATE Stock
    SET current_stock = current_stock + :NEW.quantity
    WHERE ingredient_id = :NEW.ingredient_id;
    
    -- 재고 기록 생성
    INSERT INTO Stock_Logs (stock_log_id, ingredient_id, change_amount, log_date, reason)
    VALUES (stock_log_seq.NEXTVAL, :NEW.ingredient_id, :NEW.quantity, SYSDATE, '주문으로 인한 증가');
END;
/

-- 3. 재고 변경 시 기록 생성 트리거
CREATE OR REPLACE TRIGGER log_stock_changes
AFTER UPDATE ON Stock
FOR EACH ROW
BEGIN
    INSERT INTO Stock_Logs (stock_log_id, ingredient_id, change_amount, log_date, reason)
    VALUES (
        stock_log_seq.NEXTVAL,
        :NEW.ingredient_id,
        :NEW.current_stock - :OLD.current_stock,
        SYSDATE,
        '재고 수동 변경'
    );
END;
/
```
**트리거 순서**
1. `update_stock_after_sale`: **판매 이후 재고 감소** 처리.
2. `update_stock_after_order`: **주문 이후 재고 증가** 처리.
3. `log_stock_changes`: **재고 변경 기록** 자동 생성.

<br/><br/>

## **4. 기본 테스트 데이터 생성 쿼리**
-----

```sql
-- 1. 직급 데이터
INSERT INTO Roles (role_id, role_name) VALUES (1, '크루');
INSERT INTO Roles (role_id, role_name) VALUES (2, '리더');
INSERT INTO Roles (role_id, role_name) VALUES (3, '매니저');

-- 2. 직원 데이터
INSERT INTO Employees (employee_id, password_hash, name, contact, hire_date, role_id)
VALUES (employee_seq.NEXTVAL, 'hash12345', '김철수', '010-1234-5678', TO_DATE('2023-01-01', 'YYYY-MM-DD'), 1);

INSERT INTO Employees (employee_id, password_hash, name, contact, hire_date, role_id)
VALUES (employee_seq.NEXTVAL, 'hash67890', '박영희', '010-2345-6789', TO_DATE('2022-12-15', 'YYYY-MM-DD'), 2);

INSERT INTO Employees (employee_id, password_hash, name, contact, hire_date, role_id)
VALUES (employee_seq.NEXTVAL, 'hash11111', '이민호', '010-3456-7890', TO_DATE('2021-06-01', 'YYYY-MM-DD'), 3);

-- 3. 재료 카테고리 데이터
INSERT INTO Ingredient_Categories (category_id, category_name) VALUES (1, '채소');
INSERT INTO Ingredient_Categories (category_id, category_name) VALUES (2, '육류');
INSERT INTO Ingredient_Categories (category_id, category_name) VALUES (3, '소스');
INSERT INTO Ingredient_Categories (category_id, category_name) VALUES (4, '기타');

-- 4. 재료 데이터
INSERT INTO Ingredients (ingredient_id, category_id, name, unit_price, unit)
VALUES (ingredient_seq.NEXTVAL, 1, '양상추', 200, 'g');

INSERT INTO Ingredients (ingredient_id, category_id, name, unit_price, unit)
VALUES (ingredient_seq.NEXTVAL, 1, '토마토', 300, 'g');

INSERT INTO Ingredients (ingredient_id, category_id, name, unit_price, unit)
VALUES (ingredient_seq.NEXTVAL, 2, '소고기 패티', 1500, '개');

INSERT INTO Ingredients (ingredient_id, category_id, name, unit_price, unit)
VALUES (ingredient_seq.NEXTVAL, 3, '케첩', 100, 'g');

INSERT INTO Ingredients (ingredient_id, category_id, name, unit_price, unit)
VALUES (ingredient_seq.NEXTVAL, 4, '번(빵)', 500, '개');

-- 5. 재고 데이터
INSERT INTO Stock (ingredient_id, current_stock) VALUES (1, 1000); -- 양상추 1kg
INSERT INTO Stock (ingredient_id, current_stock) VALUES (2, 500);  -- 토마토 500g
INSERT INTO Stock (ingredient_id, current_stock) VALUES (3, 200);  -- 소고기 패티 200개
INSERT INTO Stock (ingredient_id, current_stock) VALUES (4, 300);  -- 케첩 300g
INSERT INTO Stock (ingredient_id, current_stock) VALUES (5, 150);  -- 번 150개

-- 6. 상품 카테고리 데이터
INSERT INTO Product_Categories (category_id, category_name) VALUES (1, '버거');
INSERT INTO Product_Categories (category_id, category_name) VALUES (2, '음료');
INSERT INTO Product_Categories (category_id, category_name) VALUES (3, '사이드');

-- 7. 상품 데이터
INSERT INTO Products (product_id, category_id, name, price)
VALUES (product_seq.NEXTVAL, 1, '치즈버거', 5000);

INSERT INTO Products (product_id, category_id, name, price)
VALUES (product_seq.NEXTVAL, 1, '불고기버거', 5500);

-- 8. 상품-재료 매핑 데이터
-- 치즈버거
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (1, 1, 50); -- 양상추 50g
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (1, 2, 30); -- 토마토 30g
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (1, 3, 1);  -- 소고기 패티 1개
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (1, 4, 20); -- 케첩 20g
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (1, 5, 1);  -- 번 1개

-- 불고기버거
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (2, 1, 40); -- 양상추 40g
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (2, 3, 1);  -- 소고기 패티 1개
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (2, 4, 20); -- 케첩 20g
INSERT INTO Product_Ingredients (product_id, ingredient_id, required_amount)
VALUES (2, 5, 1);  -- 번 1개

-- 9. 기본 주문 데이터
INSERT INTO Orders (order_id, ingredient_id, supplier, order_date, quantity, total_price)
VALUES (order_seq.NEXTVAL, 1, '채소 공급사 A', SYSDATE, 500, 1000);

INSERT INTO Orders (order_id, ingredient_id, supplier, order_date, quantity, total_price)
VALUES (order_seq.NEXTVAL, 3, '육류 공급사 B', SYSDATE, 100, 150000);

-- 10. 기본 판매 데이터
INSERT INTO Sales (sale_id, product_id, sale_date, quantity, total_price)
VALUES (sale_seq.NEXTVAL, 1, SYSDATE, 2, 10000); -- 치즈버거 2개 판매

INSERT INTO Sales (sale_id, product_id, sale_date, quantity, total_price)
VALUES (sale_seq.NEXTVAL, 2, SYSDATE, 1, 5500); -- 불고기버거 1개 판매
```

<br/><br/>

## **5. 기타**
-----

```sql
-- 테이블, 시퀀스, 트리거 삭제
BEGIN
    FOR rec IN (SELECT table_name FROM user_tables) LOOP
        EXECUTE IMMEDIATE 'DROP TABLE ' || rec.table_name || ' CASCADE CONSTRAINTS';
    END LOOP;
END;
/

BEGIN
    FOR rec IN (SELECT sequence_name FROM user_sequences) LOOP
        EXECUTE IMMEDIATE 'DROP SEQUENCE ' || rec.sequence_name;
    END LOOP;
END;
/

BEGIN
    FOR rec IN (SELECT trigger_name FROM user_triggers) LOOP
        EXECUTE IMMEDIATE 'DROP TRIGGER ' || rec.trigger_name;
    END LOOP;
END;
/

```




