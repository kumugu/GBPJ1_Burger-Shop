# 2. DB 설계 및 설정 (2번 문서)

## 2.1 ERD (Entity-Relationship Diagram)
프로젝트에서 설계한 주요 테이블 간 관계를 다이어그램으로 제공 ( 어떻게 변경되었는지) 

```mermaid

erDiagram
    INGREDIENT_CATEGORIES ||--o{ INGREDIENTS : "contains"
    INGREDIENTS ||--o{ STOCK : "tracks"
    INGREDIENTS ||--o{ ORDERS : "orders"
    INGREDIENTS ||--o{ PRODUCT_INGREDIENTS : "used_in"
    PRODUCTS ||--o{ PRODUCT_INGREDIENTS : "requires"
    PRODUCT_CATEGORIES ||--o{ PRODUCTS : "categorizes"
    PRODUCTS ||--o{ SALES : "sold"
    PRODUCTS ||--o{ MENU : "displays"
    SALES ||--o{ PROFITLOSSREPORT : "contributes_to"
    ORDERS ||--o{ PROFITLOSSREPORT : "contributes_to"
    SALARIES ||--o{ PROFITLOSSREPORT : "contributes_to"
    ROLES ||--o{ EMPLOYEES : "has"
    EMPLOYEES ||--o{ SALARIES : "receives"

    ROLES {
        number role_id PK
        string role_name
    }
    EMPLOYEES {
        number employee_id PK
        string username
        string name
        string contact
        date hire_date
        number role_id FK
    }
    SALARIES {
        number salary_id PK
        number employee_id FK
        date payment_date
        number payment_amount
        string payment_type
    }
    INGREDIENT_CATEGORIES {
        number category_id PK
        string category_name
    }
    INGREDIENTS {
        number ingredient_id PK
        number category_id FK
        string name
        number unit_price
        string unit
    }
    STOCK {
        number ingredient_id PK
        number current_stock
    }
    ORDERS {
        number order_id PK
        number ingredient_id FK
        string supplier
        date order_date
        number quantity
        number total_price
    }
    PRODUCT_CATEGORIES {
        number category_id PK
        string category_name
    }
    PRODUCTS {
        number product_id PK
        number category_id FK
        string name
        number price
        number cost_price
    }
    SALES {
        number sale_id PK
        number product_id FK
        date sale_date
        number quantity
        number total_price
    }
    PRODUCT_INGREDIENTS {
        number product_id FK
        number ingredient_id FK
        number required_amount
    }
    MENU {
        number menu_id PK
        number product_id FK
        number display_order
        string is_visible
    }
    PROFITLOSSREPORT {
        number report_id PK
        date report_date
        number total_sales_revenue
        number total_product_cost
        number total_ingredient_cost
        number total_salary_expenses
        number total_profit
        timestamp created_at
        timestamp updated_at
    }

```



## 2.2 테이블 설계 및 관계 설명
Products, Ingredients, Sales: 상품, 재료, 판매 간 관계 설계
Stock 및 Order: 재고 추적 및 재료 주문 처리 방식
Salary 및 ProfitLossReport: 급여 지급 내역 및 손익 계산서 관련 테이블 설계

## 2.3 트리거 및 시퀀스
재고 부족 처리 트리거: 판매 시 재고가 부족하면 예외 발생
시퀀스 설정: 각 테이블에 대한 자동 증가 시퀀스 생성 (예: seq_sale_id, seq_product_id)
```sql
CREATE OR REPLACE TRIGGER check_stock_before_sale
BEFORE INSERT ON SALES
FOR EACH ROW
DECLARE
    insufficient_stock EXCEPTION;
    current_stock NUMBER;
BEGIN
    FOR r IN (
        SELECT ingredient_id, required_amount * :NEW.quantity AS total_required
        FROM PRODUCT_INGREDIENTS
        WHERE product_id = :NEW.product_id
    ) LOOP
        SELECT current_stock
        INTO current_stock
        FROM STOCK
        WHERE ingredient_id = r.ingredient_id;

        IF current_stock < r.total_required THEN
            RAISE insufficient_stock;
        END IF;
    END LOOP;
EXCEPTION
    WHEN insufficient_stock THEN
        RAISE_APPLICATION_ERROR(-20001, '재고가 부족하여 판매를 처리할 수 없습니다.');
END;
/
```

# 2.4 기본 데이터 삽입 및 순서 
순서에 맞춰 테이블에 데이터 삽입: Sales, Products, Stock 등 핵심 데이터를 먼저 삽입하여 연관된 테이블과의 관계를 형성


복붙할 쿼리문 문서는 따로 4번문서에 제공
